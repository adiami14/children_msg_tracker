<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Control Panel</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .inline {
            display: inline-block;
            margin-right: 10px;
        }
        select, input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>Server Control Panel</h1>
    
    <button onclick="handleLocation()">Send Location</button><br><br>
    
    <button onclick="handleBirthdays()">Notify Birthdays</button>
    <input type="number" id="days" placeholder="Days">
    <input type="text" id="user" placeholder="User"><br><br>
    
    <button onclick="checkSensorsAlive()">Check Sensors Alive</button><br><br>
    
    <button onclick="updatePlantIsDry()">Update Plant is Dry</button>
    <input type="text" id="ip" placeholder="IP Address"><br><br>
    
    <button onclick="getMeasurements()">Get Measurements</button><br><br>
    
    <button onclick="resetNotifyFlags()">Reset Notify Flags</button><br><br>
    
    <button onclick="resetErrorFlags()">Reset Error Flags</button><br><br>
    
    <button onclick="onMyWayHome()">Notify Wife: On My Way Home</button><br><br>
    
    <button onclick="databaseBackup()">Database Backup</button><br><br>
    
    <button onclick="isUrgent()">Notify Wife: Is Urgent</button><br><br>
    
    <button onclick="getConnectedGuests()">See Current Connected Guests</button><br><br>
    
    <button onclick="GetNetworkEntities()">Known Network Entities</button><br><br>

    <button onclick="freequery()">Use your own queries</button>
    <input type="text" id="query"><br><br>

    <button onclick="removeByIP()">Remove by IP</button>
    <input type="text" id="remove_ip" placeholder="IP Address">
    <select id="remove_table">
        <option value="connected_guests">current_connected_devices</option>
        <option value="network_entries">Network Entries</option>
    </select><br><br>
    
    <button onclick="updateTable()">update table</button><br>

    <h1 class="inline">UPDATE</h1>
    <select id="table" class="inline">
        <option value="connected_guests">Connected Guests</option>
        <option value="network_entries">Network Entries</option>
    </select>
    <h1 class="inline">SET</h1>
    <select id="field_to_change" class="inline">
        <option value="Category">Category</option>
        <option value="Device">Device</option>
        <option value="IP">IP</option>
        <option value="MAC">MAC</option>
        <option value="Footing">Footing</option>
    </select>
    <h1 class="inline">=</h1>
    <input type="text" id="set_value" class="inline">
    <h1 class="inline">WHERE</h1>
    <select id="where_filed" class="inline">
        <option value="Category">Category</option>
        <option value="Device">Device</option>
        <option value="IP">IP</option>
        <option value="MAC">MAC</option>
        <option value="Footing">Footing</option>
    </select>
    <h1 class="inline">=</h1>
    <input type="text" id="where_value" class="inline">
    
    <div id="query_display"></div>
    <span id="display_span1"></span><br><br>
    <span id="display_span2"></span><br><br>
    <span id="display_span3"></span><br><br>
    <div id="result"></div>

    <script>
        function sendRequest(url, params, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url + "?" + params, true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    callback(xhr.responseText);
                }
            };
            xhr.send();
        }

        function handleLocation() {
            sendRequest("/location", "", displayResult);
        }
        function freequery() {
            var query = document.getElementById("query").value;
            sendRequest("/database/get", "query="+query, displayResult);
        }
        
        function getConnectedGuests() {
            sendRequest("/database/last_modified", "table=current_connected_devices", displayResultSpan1);
            sendRequest("/network_scanner/get_last_netscan", "", displayResultSpan2);
            sendRequest("/database/get", "query=select * from current_connected_devices;", displayPrettyResult);
        }
        function GetNetworkEntities() {
            sendRequest("/database/get", "query=select * from network_entries;", displayPrettyResult);
        }

        function handleBirthdays() {
            var days = document.getElementById("days").value;
            var user = document.getElementById("user").value;
            sendRequest("/birthdays", "days=" + days + "&user=" + user, displayResult);
        }

        function checkSensorsAlive() {
            sendRequest("/plants/check_sensors_alive", "", displayResult);
        }
        function updateTable() {
            var table = document.getElementById("table").value;
            var field_to_change = document.getElementById("field_to_change").value;
            var set_value = document.getElementById("set_value").value;
            var where_filed = document.getElementById("where_filed").value;
            var where_value = document.getElementById("where_value").value;
            var query = "UPDATE `" + table + "` SET `" + field_to_change + "` = '" + set_value + "' WHERE `" + where_filed + "` = '" + where_value + "';"

            // Display the query on the screen
            document.getElementById("query_display").innerText = query;

            sendRequest("/database/update", "query=" + encodeURIComponent(query), displayResult);
        }
        function updatePlantIsDry() {
            var ip = document.getElementById("ip").value;
            sendRequest("/plants/update_plant_is_dry", "ip=" + ip, displayResult);
        }

        function getMeasurements() {
            sendRequest("/plants/get_measurements", "", displayPlantsTable);
        }

        function resetNotifyFlags() {
            sendRequest("/plants/reset_notify_flags", "", displayResult);
        }

        function resetErrorFlags() {
            sendRequest("/plants/reset_error_flags", "", displayResult);
        }

        function onMyWayHome() {
            sendRequest("/notify_wife/way_home", "", displayResult);
        }

        function databaseBackup() {
            sendRequest("/database/backup", "", displayResult);
        }

        function isUrgent() {
            sendRequest("/notify_wife/urgent", "", displayResult);
        }

        function removeByIP() {
            var ip = document.getElementById("remove_ip").value;
            var table = document.getElementById("remove_table").value;
            sendRequest("/database/update", "query=DELETE FROM " + table + " WHERE IP = '" + ip + "';", displayResult);
        }


        function displayPlantsTable(response) {
        var jsonResponse = JSON.parse(response);
        var data = jsonResponse.response.data;

        // Create a table
        var table = document.createElement("table");
        table.setAttribute("border", "1");

        // Create a header row
        var headerRow = table.insertRow();
        var headers = ["Sensor IP", "Measurement", "Is Dry?"];
        headers.forEach(function(header) {
            var th = document.createElement("th");
            th.appendChild(document.createTextNode(header));
            headerRow.appendChild(th);
        });

        // Insert data rows
        for (var ip in data) {
            if (data.hasOwnProperty(ip)) {
                var row = table.insertRow();
                var cell1 = row.insertCell();
                cell1.appendChild(document.createTextNode(ip));

                var cell2 = row.insertCell();
                cell2.appendChild(document.createTextNode(data[ip].measurment));

                var cell3 = row.insertCell();
                cell3.appendChild(document.createTextNode(data[ip].is_dry));
            }
        }

        // Clear the previous content and append the table to the result div
        var resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "";
        resultDiv.appendChild(table);
    }


        function displayResult(response) {
            var jsonResponse = JSON.parse(response);
            var data = jsonResponse.response.data;
            
            // Convert the data object to a string representation
            var displayString = JSON.stringify(data, null, 2);
            
            // Display the string representation in the HTML element
            document.getElementById("result").innerHTML = `<pre>${displayString}</pre>`;
        }
        function displayResultSpan1(response) {
            if (response){
                var jsonResponse = JSON.parse(response);
        
        // Extract the 'data' field from the response
                var data = jsonResponse.response.data;
                document.getElementById("display_span1").innerHTML = "Last modified @ " + data;
            }else{
                document.getElementById("display_span1").innerHTML = "no data...123";
            }   
        }
        function displayResultSpan2(response) {
            if (response){
                var jsonResponse = JSON.parse(response);
        
        // Extract the 'data' field from the response
                var data = jsonResponse.response;
                document.getElementById("display_span2").innerHTML = "Last Scan @    " + data;
            }else{
                document.getElementById("display_span2").innerHTML = "no data...123";
            }   
        }
        function displayResultSpan3(response) {
            if (response){
                var jsonResponse = JSON.parse(response);
        
        // Extract the 'data' field from the response
                var data = jsonResponse.response.data;
                document.getElementById("display_span1").innerHTML =  data;
            }else{
                document.getElementById("display_span1").innerHTML = "no data...";
            }   
        }

        function displayPrettyResult(response) {
            var data = JSON.parse(response).response.data;
            var html = "<table><tr><th>Category</th><th>Device Name</th><th>IP Address</th><th>MAC Address</th><th>Footing</th></tr>";
            data.forEach(function (item) {
                html += "<tr>";
                item.forEach(function (field) {
                    html += "<td>" + field + "</td>";
                });
                html += "</tr>";
            });
            html += "</table>";
            document.getElementById("result").innerHTML = html;
        }
        function displayPrettyResultPlants(response) {
            var data = JSON.parse(response).response.data;
            var html = "<table><tr><th>IP</th><th>Device Name</th><th>Measurment</th><th>Is Dry</th><th>";
            data.forEach(function (item) {
                html += "<tr>";
                item.forEach(function (field) {
                    html += "<td>" + field + "</td>";
                });
                html += "</tr>";
            });
            html += "</table>";
            document.getElementById("result").innerHTML = html;
        }
    </script>
</body>
</html>
